<div class="container my-5">
  <div class="card p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0">Gestión de Inventario (MCP)</h1>
      <button *ngIf="materialSeleccionadoId" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#entradaModal">
        <i class="bi bi-plus-circle-fill me-2"></i>Registrar Entrada
      </button>
    </div>

    <div class="mb-4">
      <label for="materialSelect" class="form-label">Selecciona un material para ver su historial:</label>
      <select id="materialSelect" class="form-select" (change)="onMaterialSelect($event)">
        <option selected value="">-- Elige un material --</option>
        <option *ngFor="let material of materiales" [value]="material.id">{{ material.nombre }}</option>
      </select>
    </div>

    <div *ngIf="materialSeleccionadoId">
      <div *ngIf="cargandoHistorial" class="text-center py-5"><div class="spinner-border"></div></div>
      <div *ngIf="!cargandoHistorial && historial.length > 0" class="table-responsive">
        <table class="table table-bordered table-striped table-sm admin-table">
          <thead class="text-center">
            <tr>
              <th rowspan="2">Fecha</th><th colspan="3">Entrada</th><th colspan="2">Salida</th><th colspan="3">Saldo</th>
            </tr>
            <tr>
              <th>Cant.</th><th>Costo U.</th><th>Debe</th><th>Cant.</th><th>Haber</th><th>Cant.</th><th>Costo P.</th><th>Saldo Valor</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let m of historial">
              <td>{{ m.fecha | date:'dd/MM/yy, h:mm a' }}</td>
              <td class="text-center">{{ m.tipo === 'Entrada' ? m.cantidadEntrada : '' }}</td>
              <td class="text-end">{{ m.tipo === 'Entrada' ? (m.costoUnitarioEntrada | currency:'MXN':'symbol':'1.4-4') : '' }}</td>
              <td class="text-end">{{ m.tipo === 'Entrada' ? (m.debe | currency:'MXN') : '' }}</td>
              <td class="text-center">{{ m.tipo === 'Salida' ? m.cantidadSalida : '' }}</td>
              <td class="text-end">{{ m.tipo === 'Salida' ? (m.haber | currency:'MXN') : '' }}</td>
              <td class="text-center fw-bold">{{ m.saldoCantidad }}</td>
              <td class="text-end fw-bold">{{ m.costoPromedioPonderado | currency:'MXN':'symbol':'1.4-4' }}</td>
              <td class="text-end fw-bold table-primary">{{ m.saldoValor | currency:'MXN' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div *ngIf="!cargandoHistorial && historial.length === 0" class="alert alert-light text-center">
        No hay movimientos registrados para este material. ¡Registra la primera entrada!
      </div>
    </div>
  </div>
</div>

<!-- Modal para Registrar Entrada -->
<div class="modal fade" id="entradaModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Registrar Entrada de Material</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form #entradaForm="ngForm" (ngSubmit)="registrarEntrada()">
          <div class="mb-3">
            <label class="form-label">Cantidad Comprada</label>
            <input type="number" class="form-control" name="cantidad" [(ngModel)]="nuevaEntrada.cantidad" required min="1">
          </div>
          <div class="mb-3">
            <label class="form-label">Costo por Unidad</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control" name="costo" [(ngModel)]="nuevaEntrada.costoUnitario" required min="0.01" step="0.01">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="entradaForm.invalid" data-bs-dismiss="modal">Guardar Entrada</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
